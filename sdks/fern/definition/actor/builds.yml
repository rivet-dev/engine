# yaml-language-server: $schema=https://raw.githubusercontent.com/fern-api/fern/main/fern.schema.json

imports:
  commons: ../common.yml
  localCommons: common.yml
  uploadCommons: ../upload/common.yml

service:
  auth: true
  base-path: /builds
  audiences:
    - runtime
  endpoints:
    get:
      path: /{build}
      method: GET
      docs: >-
        Get a build.
      path-parameters:
        build: uuid
      request:
        name: GetBuildRequestQuery
        query-parameters:
          project: optional<string>
          environment: optional<string>
      response: GetBuildResponse

    list:
      path: ""
      method: GET
      docs: >-
        Lists all builds of the project associated with the token used. Can be
        filtered by tags in the query string.
      request:
        name: ListBuildsRequestQuery
        query-parameters:
          project: optional<string>
          environment: optional<string>
          tags_json: optional<string>
      response: ListBuildsResponse

    patchTags:
      path: /{build}/tags
      method: PATCH
      path-parameters:
        build: uuid
      request:
        name: PatchBuildTagsRequestQuery
        body: PatchBuildTagsRequest
        query-parameters:
          project: optional<string>
          environment: optional<string>
      response: PatchBuildTagsResponse

    prepare:
      path: /prepare
      method: POST
      docs: Creates a new project build for the given project.
      request:
        name: PrepareBuildRequestQuery
        body: PrepareBuildRequest
        query-parameters:
          project: optional<string>
          environment: optional<string>
      response: PrepareBuildResponse

    complete:
      path: /{build}/complete
      method: POST
      docs: Marks an upload as complete.
      path-parameters:
        build: uuid
      request:
        name: CompleteBuildRequestQuery
        query-parameters:
          project: optional<string>
          environment: optional<string>

types:
  GetBuildResponse:
    properties:
      build: localCommons.Build

  ListBuildsResponse:
    properties:
      builds:
        docs: A list of builds for the project associated with the token.
        type: list<localCommons.Build>

  PatchBuildTagsRequest:
    properties:
      tags: unknown
      exclusive_tags:
        docs: Removes the given tag keys from all other builds.
        type: optional<list<string>>

  PatchBuildTagsResponse:
    properties: {}

  PrepareBuildRequest:
    properties:
      name: string
      tags: unknown
      image_tag:
        docs: A tag given to the project build.
        type: optional<string>
      image_file: uploadCommons.PrepareFile
      multipart_upload:
        type: optional<boolean>
      kind: optional<BuildKind>
      compression: optional<BuildCompression>

  PrepareBuildResponse:
    properties:
      build: uuid
      presigned_requests: list<uploadCommons.PresignedRequest>

  BuildKind:
    enum:
      - value: docker_image
        docs: Docker image archive generated by `docker save`.
      - value: oci_bundle
        docs: OCI-compliant bundle.
      - value: javascript
        docs: A JavaScript file.

  BuildCompression:
    enum:
      - value: none
        docs: None compression.
      - value: lz4
        docs: LZ4 compression. Use the minimum compression level.
