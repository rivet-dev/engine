# Monolith Development Container

This container is intended for quickly running Rivet with a single `docker run` command or integrating Rivet
in to an existing Docker Compose environment.

## Running

### Build image

Before running the image, it needs to be built:

```bash
docker build -f docker/monolith/Dockerfile -t rivet .
```

### Run via `docker run`

```bash
docker run -v "$(pwd)/rivet-data:/data" -p 8080:8080 -p 9000:9000 -p 7080:7080 -p 7443:7443 -p 7500-7599:7500-7599 -p 7600-7699:7600-7699 --platform linux/amd64 rivetgg/rivet
```

### Run via Docker Compose

```yaml
services:
  rivet:
    image: rivetgg/rivet
    platform: linux/amd64
    volumes:
      - rivet-data:/data
    ports:
      - "8080:8080"
      - "9000:9000"
      - "7080:7080"
      - "7443:7443"
      - "7500-7599:7500-7599"
      - "7600-7699:7600-7699"

volumes:
  rivet-data:
```

## Logs

Logs live in the `/var/log/{service name}` directory.

You can read the logs by running:

```bash
docker exec mycontainer cat /var/log/rivet-server/current
```

## Monitoring Vector

Monitor `vector-server`:

```bash
vector top --url http://0.0.0.0:9500/graphql
```

Monitor `vector-client`:

```bash
vector top --url http://0.0.0.0:9510/graphql
```

## Development

Build & run the monolith container with extra logs enabled with:

```bash
./scripts/docker/monolith_dev.ts
```

Flags:

- `--no-build` Skip build step
- `--no-clean` Skips removing data dir

Data will be stored in `/tmp/rivet-data`.

## Port collisions

Because all services live in the same address space, a lot of ports for dependent services are remapped.

If a port uses numbers non-standard ports (e.g. ClickHouse has
[many ports](https://clickhouse.com/docs/en/guides/sre/network-ports) while Redis uses a single well-known
port 6379). TODO

## `s6-overlay` & generating services

All required services run inside the container by default using `s6-overlay`.

These services are auto-generated by the `./scripts/docker/generate.ts` script.
