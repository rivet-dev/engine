version: '3.8'

services:
  rivet:
    build:
      context: ../..
      dockerfile: docker/dev-full/server.Dockerfile
    command: /usr/bin/rivet server
    environment:
      - RUST_BACKTRACE=1
    stop_grace_period: 0s
    ports:
      # API
      - "8080:8080"
      # API internal
      - "8081:8080"
      # Pegboard
      - "8082:8082"
    depends_on:
      cockroachdb:
        condition: service_healthy
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      nats:
        condition: service_healthy
      seaweedfs:
        condition: service_healthy
      vector:
        condition: service_started
    volumes:
      - ./rivet:/etc/rivet:ro
    networks:
      - rivet-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/health"]
      interval: 2s
      timeout: 10s
      retries: 10

  shell:
    build:
      context: ../../..
      dockerfile: docker/dev-full/server.Dockerfile
    command: sleep infinity
    stop_grace_period: 0s
    volumes:
      - ./rivet:/etc/rivet:ro
    networks:
      - rivet-network

  shell:
    build:
      context: ../../..
      dockerfile: docker/dev-full/client.Dockerfile
    stop_grace_period: 0s
    networks:
      - rivet-network

  cockroachdb:
    image: cockroachdb/cockroach:v24.2.3
    command: start-single-node --insecure
    volumes:
      - cockroach-data:/cockroach/cockroach-data
    networks:
      - rivet-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8080/health?ready=1"]
      interval: 2s
      timeout: 10s
      retries: 10

  redis:
    image: bitnami/valkey:8.0.1
    # TODO: Remove root user
    user: root
    volumes:
      - redis-data:/data
    command: redis-server --requirepass password --save 60 1 --appendonly yes
    networks:
      - rivet-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 10s
      retries: 10

  clickhouse:
    image: bitnami/clickhouse:23.10.1
    environment:
      - CLICKHOUSE_ADMIN_PASSWORD=default
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ./clickhouse/users.xml:/etc/clickhouse-server/users.d/users.xml:ro
    networks:
      - rivet-network
    healthcheck:
      test: ["CMD", "clickhouse-client", "--password", "default", "--query", "SELECT 1"]
      interval: 2s
      timeout: 10s
      retries: 10

  nats:
    image: nats:2.10.22-scratch
    networks:
      - rivet-network
    healthcheck:
      test: ["CMD", "nats-server", "--health"]
      interval: 2s
      timeout: 10s
      retries: 10

  prometheus:
    image: bitnami/prometheus:2.55.0
    volumes:
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - rivet-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:9090/-/healthy"]
      interval: 2s
      timeout: 10s
      retries: 10

  grafana:
    image: grafana/grafana:11.3.0
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    networks:
      - rivet-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3000/api/health"]
      interval: 2s
      timeout: 10s
      retries: 10

  seaweedfs:
    image: bitnami/seaweedfs:3.78.0
    command: server -dir /var/lib/seaweedfs -s3 -s3.config /etc/seaweedfs/s3.json -s3.port=8000 -s3.allowEmptyFolder=false -s3.allowDeleteBucketNotEmpty=false
    volumes:
      - ./seaweedfs:/etc/seaweedfs:ro
      - seaweedfs-data:/var/lib/seaweedfs
    networks:
      - rivet-network
    healthcheck:
      test: ["CMD", "bash", "-c", ">/dev/tcp/127.0.0.1/8000"]
      interval: 2s
      timeout: 10s
      retries: 10

  vector:
    image: timberio/vector:0.42.0-distroless-static
    volumes:
      - vector-data:/var/lib/vector
    networks:
      - rivet-network

networks:
  rivet-network:
    driver: bridge

volumes:
  cockroach-data:
  redis-data:
  clickhouse-data:
  prometheus-data:
  grafana-data:
  seaweedfs-data:
  vector-data:
